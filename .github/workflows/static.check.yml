name: Static checkers and verifiers

# "Pre-build" Scripts from TAOS-CI
# @todo Make this "reusable workflow" and publish for all projects.

## Common variables and files
# - changed_file_list in GITHUB_ENV: the list of files updated in this pull-request.

on:
  pull_request:
    branches: [ main ]

jobs:
  simple_script_checkers:
    runs-on: ubuntu-latest
    name: Static checks
    steps:
      - name: Preparing step 1... Checking out
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: -${{ github.event.pull_request.commits }}
      - name: Preparing step 2... Installing packages
        run: sudo apt-get update && sudo apt-get install clang-format git grep gawk exuberant-ctags indent pylint
      - name: Preparing step 3... Identify changed files
        run: |
          tmpfile_pre=$(mktemp)
          tmpfile=$(mktemp)
          git show --pretty="format:" --name-only --diff-filter=AMRC ${{ github.event.pull_request.head.sha}} -${{ github.event.pull_request.commits }} > ${tmpfile_pre}

          ####### Screen out deleted files from the file list!!!

          echo "::group::The list of changed files"
          for file in `cat ${tmpfile_pre}`; do
            if [[ -f $file ]]; then
              echo "$file"
              echo "$file" >> $tmpfile
            else
              echo "$file is deleted."
            fi
          done
          echo "::endgroup::"
          echo "changed_file_list=${tmpfile}" >> "$GITHUB_ENV"
      - name: /Checker/ clang-format for .cc/.hh/.hpp/.cpp files
        # Originally from "pr-prebuild-clang"
        # Need "clang-format"
        run: |
          echo "Check .clang-format file"
          if [ ! -f ".clang-format" ]; then
            echo "::error .clang-format file not found"
            exit 1
          fi
          for file in `cat $changed_file_list`; do
            echo "Checking $file"
            if [[ "$file" =~ .*\.hh$ ]] || [[ "$file" =~ .*\.hpp ]] || [[ "$file" =~ .*\.cc$ ]] || [[ "$file" =~ .*\.cpp ]]; then
              clang-format -i ${file}
            fi
          done
          git diff -- *.cc *.hh *.hpp *.cpp > .ci.clang-format.patch
          SIZE=$(stat -c%s .ci.clang-format.patch)
          if [[ $SIZE -ne 0 ]]; then
            echo "::group::The clang-format complaints..."
            cat .ci.clang-format.patch
            echo "::endgroup::"
            echo "::error clang-format has found style errors in C++ files."
            exit 1
          fi
          echo "clang-format shows no style errors."
      - name: /Checker/ File size check
        # Originally from "pr-prebuild-file-size"
        run: |
          for file in `cat $changed_file_list`; do
            echo "Checking $file"
            FILESIZE=$(stat -c%s "$file")
            FILESIZE_NUM=`echo $FILESIZE | sed ':a;s/\B[0-9]\{3\}\>/,&/;ta'`
            if [[ $FILESIZE -gt $[ 5*1024*1024 ] ]]; then
              echo "::error $file is too large: $FILESIZE > 5MiB"
              exit 1
            fi
          done
      - name: /Checker/ Doxygen tag check
        # Originally from "pr-prebuild-doxygen-tag"
        # Need "grep"
        run: |
          for file in `cat $changed_file_list`; do
            echo "Checking $file"
            if [[ `file $file | grep "ASCII text" | wc -l` -gt 0 ]]; then
              bash .github/workflows/static.check.scripts/doxygen-tag.sh $file 1
            fi
          done
      - name: /Checker/ Indent
        # Originally from "pr-prebuild-indent"
        # Need "indent"
        run: |
          bash .github/workflows/static.check.scripts/indent.sh $changed_file_list
      - name: /Checker/ Pylint
        # Originally from "pr-prebuild-pylint"
        # Need "pylint"
        run: |
          bash .github/workflows/static.check.scripts/pylint.sh $changed_file_list
      - name: /Checker/ Newline
        # Originally from "pr-prebuild-newline"
        run: |
          bash .github/workflows/static.check.scripts/newline.sh $changed_file_list
